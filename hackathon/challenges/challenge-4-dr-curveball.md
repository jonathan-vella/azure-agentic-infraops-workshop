# Challenge 4: The Curveball ‚Äî High Availability & Disaster Recovery

> **Duration**: 40 minutes | **Announced at**: 13:50 | **Output**: Updated architecture + Deployed DR infrastructure + ADR

## ‚ö° The Announcement

> **COACH READS AT 13:50:**
>
> _"ATTENTION ALL TEAMS! üì£_
>
> _We've just received urgent news from Nordic Fresh Foods headquarters!_
>
> _They've signed a major contract with a Danish restaurant chain ‚Äî Sm√∏rrebr√∏d Express ‚Äî worth
> ‚Ç¨500K annually. The board has convened an emergency meeting and approved increased infrastructure investment._
>
> _Your infrastructure must now support high availability with disaster recovery capabilities!_
>
> _You have 40 minutes to propose, plan, and **deploy** the solution!_ üöÄ"

## New Business Requirements

| Requirement          | Value                | Business Impact                               |
| -------------------- | -------------------- | --------------------------------------------- |
| **RTO**              | ‚â§1 hour              | Maximum acceptable downtime                   |
| **RPO**              | ‚â§15 minutes          | Maximum acceptable data loss                  |
| **Secondary Region** | `germanywestcentral` | Coverage for broader European market          |
| **Budget Increase**  | +‚Ç¨200/month          | Total infrastructure budget now ~‚Ç¨700/month   |
| **Timeline**         | 40 minutes           | Board needs decision on architecture approach |

## Your Challenge

You must decide: **What level of HA/DR does the business need?**

### Option A: Single-Region HA

- All resources in `swedencentral`
- Zone-redundant services where available
- Faster failover, lower cost
- Risk: Regional outage affects all services

### Option B: Multi-Region DR

- Primary: `swedencentral`, Secondary: `germanywestcentral`
- Geo-replication for data
- Higher cost, longer RTO
- Risk: Complexity in failover orchestration

### Option C: Multi-Region Active-Active

- Both regions serve traffic simultaneously
- Highest availability, highest cost
- Risk: Data consistency challenges

**Your Task**: Choose an approach and design it as a **parameterized solution**.

## Required Deliverables

### 1. Architecture Decision Record (ADR) ‚≠ê MANDATORY

Create: `agent-output/freshconnect/04-adr-ha-dr-strategy.md`

Your ADR must document:

**Context**: Why is this decision needed?

- What changed in the business requirements?
- What are the consequences of not addressing this?

**Decision**: What approach did you choose and why?

- Single-region HA vs multi-region DR vs active-active?
- Which services need redundancy?
- What's your failover strategy?

**Consequences**: What are the trade-offs?

- Cost implications (+‚Ç¨200 budget: is it enough?)
- Operational complexity
- RTO/RPO achievability
- Risks and mitigation strategies

**Alternatives Considered**: What did you reject and why?

- Why not the other options?
- What would make you reconsider?

### 2. Updated Bicep (Parameterized)

Add a parameter to your `main.bicep` that enables HA/DR:

**Concept**:

```bicep
param haStrategy string = 'single-region' // 'single-region' or 'multi-region'
param primaryLocation string = 'swedencentral'
param secondaryLocation string = 'germanywestcentral'
```

**Questions to Explore**:

- How do you prompt the `bicep-code` agent to add this capability?
- Which modules need to change?
- What resources must exist in both regions?
- How do you handle data replication?

### 3. Deploy DR Infrastructure ‚≠ê REQUIRED

After updating your Bicep templates, deploy the DR infrastructure:

```powershell
# Preview changes first
az deployment group what-if \
  --resource-group rg-freshconnect-dev-swc \
  --template-file main.bicep \
  --parameters main.bicepparam \
  --parameters haStrategy='multi-region'

# Deploy with HA enabled
az deployment group create \
  --resource-group rg-freshconnect-dev-swc \
  --template-file main.bicep \
  --parameters main.bicepparam \
  --parameters haStrategy='multi-region'
```

**Deployment Questions**:

- What new resources appear in the What-If output?
- Are there any resources that need to be deployed to the secondary region separately?
- How do you verify that geo-replication is working?

### 4. Updated Architecture Diagram ‚≠ê MANDATORY

Use the `diagram` agent to update your architecture diagram showing:

- Primary and secondary region resources
- Geo-replication connections
- Failover paths and traffic routing
- Data synchronization flows

```
Use the `diagram` agent to update the FreshConnect architecture diagram
to show HA/DR configuration based on agent-output/freshconnect/04-adr-ha-dr-strategy.md
```

**Save your updated diagram** ‚Äî you'll need it for your Partner Showcase in Challenge 8.

### 5. Updated Cost Estimate

**Consider**:

- Does your solution fit in the +‚Ç¨200 budget increase?
- What are the major cost drivers for HA/DR?
- Where could you optimize if over budget?

## Success Criteria

| Criterion                           | Points |
| ----------------------------------- | ------ |
| ADR documented with clear rationale | 2      |
| HA/DR approach chosen and justified | 2      |
| Bicep parameterized for HA strategy | 2      |
| **DR infrastructure deployed**      | 2      |
| Updated architecture diagram        | 2      |
| **Total**                           | **10** |

## Time Management Tips

üí° **10 minutes**: Architecture Decision Record
üí° **15 minutes**: Prompt the `bicep-code` agent and update templates
üí° **10 minutes**: Deploy DR infrastructure
üí° **5 minutes**: Verify deployment and update cost estimate

## Coaching Approach

This challenge tests your ability to:

- Make informed decisions under time pressure
- Balance business needs with technical constraints
- Document architectural decisions clearly
- Use AI agents effectively with well-crafted prompts

**Remember**: There's no single "right answer" - the quality of your decision-making process
matters more than the specific option you choose.

## Next Step

After completing your ADR and Bicep updates:

Proceed to [Challenge 5: Load Testing](challenge-5-load-testing.md) to validate your
infrastructure can handle the expected load.
