# Sync Template from Upstream Repository
# Keeps this skeleton template in sync with azure-agentic-infraops
# Runs weekly and creates a PR with changes for review

name: Sync from Upstream

on:
  schedule:
    # Run every Monday at 06:00 UTC
    - cron: "0 6 * * 1"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (show changes without creating PR)"
        required: false
        default: false
        type: boolean

env:
  UPSTREAM_REPO: "jonathan-vella/azure-agentic-infraops"
  UPSTREAM_BRANCH: "main"

jobs:
  sync:
    name: Sync from upstream
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout template repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone upstream repository
        run: |
          git clone --depth 1 --branch ${{ env.UPSTREAM_BRANCH }} \
            https://github.com/${{ env.UPSTREAM_REPO }}.git upstream

      - name: Sync files from upstream
        run: |
          echo "üîÑ Syncing specific folders and config files from upstream repository..."
          echo ""
          echo "üìÅ Folders: .github/agents, .github/instructions, .github/skills, .github/prompts, .devcontainer, mcp, scripts"
          echo "üìÑ Config files: lefthook.yml, .gitignore, .gitattributes, .editorconfig, markdownlint, commitlint"
          echo "‚ö†Ô∏è  Source always wins - existing files will be overwritten"
          echo ""

          # Create target directories if they don't exist
          mkdir -p .github/agents .github/instructions .github/skills .github/prompts .devcontainer mcp scripts

          # Sync .github/agents (source wins)
          if [ -d "upstream/.github/agents" ]; then
            echo "üìÇ Syncing .github/agents..."
            rsync -av --delete upstream/.github/agents/ .github/agents/
            echo "  ‚úì Synced"
          else
            echo "  ‚ö†Ô∏è  upstream/.github/agents not found"
          fi

          # Sync .github/instructions (source wins)
          if [ -d "upstream/.github/instructions" ]; then
            echo "üìÇ Syncing .github/instructions..."
            rsync -av --delete upstream/.github/instructions/ .github/instructions/
            echo "  ‚úì Synced"
          else
            echo "  ‚ö†Ô∏è  upstream/.github/instructions not found"
          fi

          # Sync .github/skills (source wins)
          if [ -d "upstream/.github/skills" ]; then
            echo "üìÇ Syncing .github/skills..."
            rsync -av --delete upstream/.github/skills/ .github/skills/
            echo "  ‚úì Synced"
          else
            echo "  ‚ö†Ô∏è  upstream/.github/skills not found"
          fi

          # Sync .github/prompts (source wins)
          if [ -d "upstream/.github/prompts" ]; then
            echo "üìÇ Syncing .github/prompts..."
            rsync -av --delete upstream/.github/prompts/ .github/prompts/
            echo "  ‚úì Synced"
          else
            echo "  ‚ö†Ô∏è  upstream/.github/prompts not found"
          fi

          # Sync .devcontainer (source wins)
          if [ -d "upstream/.devcontainer" ]; then
            echo "üìÇ Syncing .devcontainer..."
            rsync -av --delete upstream/.devcontainer/ .devcontainer/
            echo "  ‚úì Synced"
          else
            echo "  ‚ö†Ô∏è  upstream/.devcontainer not found"
          fi

          # Sync mcp folder (source wins)
          if [ -d "upstream/mcp" ]; then
            echo "üìÇ Syncing mcp..."
            rsync -av --delete upstream/mcp/ mcp/
            echo "  ‚úì Synced"
          else
            echo "  ‚ö†Ô∏è  upstream/mcp not found"
          fi

          # Sync scripts folder (source wins)
          if [ -d "upstream/scripts" ]; then
            echo "üìÇ Syncing scripts..."
            rsync -av --delete upstream/scripts/ scripts/
            echo "  ‚úì Synced"
          else
            echo "  ‚ö†Ô∏è  upstream/scripts not found"
          fi

          echo ""
          echo "üìÑ Syncing configuration files..."

          # Sync lefthook.yml
          if [ -f "upstream/lefthook.yml" ]; then
            cp upstream/lefthook.yml lefthook.yml
            echo "  ‚úì lefthook.yml"
          fi

          # Sync .gitignore
          if [ -f "upstream/.gitignore" ]; then
            cp upstream/.gitignore .gitignore
            echo "  ‚úì .gitignore"
          fi

          # Sync .gitattributes
          if [ -f "upstream/.gitattributes" ]; then
            cp upstream/.gitattributes .gitattributes
            echo "  ‚úì .gitattributes"
          fi

          # Sync .editorconfig
          if [ -f "upstream/.editorconfig" ]; then
            cp upstream/.editorconfig .editorconfig
            echo "  ‚úì .editorconfig"
          fi

          # Sync markdownlint configs
          if [ -f "upstream/.markdownlint.json" ]; then
            cp upstream/.markdownlint.json .markdownlint.json
            echo "  ‚úì .markdownlint.json"
          fi

          if [ -f "upstream/.markdownlint-cli2.jsonc" ]; then
            cp upstream/.markdownlint-cli2.jsonc .markdownlint-cli2.jsonc
            echo "  ‚úì .markdownlint-cli2.jsonc"
          fi

          if [ -f "upstream/.markdownlintignore" ]; then
            cp upstream/.markdownlintignore .markdownlintignore
            echo "  ‚úì .markdownlintignore"
          fi

          # Sync markdown-link-check config
          if [ -f "upstream/.markdown-link-check.json" ]; then
            cp upstream/.markdown-link-check.json .markdown-link-check.json
            echo "  ‚úì .markdown-link-check.json"
          fi

          # Sync commitlint config
          if [ -f "upstream/commitlint.config.js" ]; then
            cp upstream/commitlint.config.js commitlint.config.js
            echo "  ‚úì commitlint.config.js"
          fi

          # Sync package.json (but preserve workshop-specific name and version)
          if [ -f "upstream/package.json" ]; then
            echo "  ‚ÑπÔ∏è  package.json - preserving workshop name/version"
            # We'll do a smarter merge here - take upstream but keep workshop identity
            # For now, just note it needs manual review
            cp upstream/package.json package.json.upstream
            echo "  ‚ö†Ô∏è  package.json.upstream created for manual review"
          fi

          # Cleanup upstream clone
          rm -rf upstream/

          echo ""
          echo "‚úÖ Sync complete"

      - name: Post-sync cleanup
        run: |
          echo "üßπ Running post-sync cleanup..."

          # No cleanup needed - we're only syncing specific folders

          echo "‚úÖ Cleanup complete"

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes detected - template is up to date"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üìù Changes detected:"
            git diff --stat
            git status --short
          fi

      - name: Show diff (dry run)
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry_run == 'true'
        run: |
          echo "üîç DRY RUN - Changes that would be applied:"
          git diff --stat
          echo ""
          echo "üìã Modified files:"
          git status --short

      - name: Get upstream version
        id: version
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          if [ -f "VERSION.md" ]; then
            VERSION=$(grep -oP '(?<=\*\*Current Version:\*\* )\d+\.\d+\.\d+' VERSION.md | head -1 || echo "unknown")
            # Fallback to old format if new format not found
            if [ "$VERSION" = "unknown" ]; then
              VERSION=$(grep -oP '(?<=## Version )\d+\.\d+\.\d+' VERSION.md | head -1 || echo "unknown")
            fi
          else
            VERSION="unknown"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Upstream version: $VERSION"

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync from upstream v${{ steps.version.outputs.version }}"
          title: "chore: Sync from upstream (v${{ steps.version.outputs.version }})"
          body: |
            ## üîÑ Upstream Sync

            This PR syncs specific folders from the upstream repository
            [azure-agentic-infraops](${{ github.server_url }}/${{ env.UPSTREAM_REPO }}).

            ### Upstream Version
            **${{ steps.version.outputs.version }}**

            ### Sync Strategy
            **Targeted sync** - Specific folders and configuration files are synced, source always wins.

            ### Synced Folders
            | Folder | Description |
            |--------|-------------|
            | `.github/agents/` | Custom Copilot agent definitions |
            | `.github/instructions/` | File-type specific instructions |
            | `.github/skills/` | Reusable agent skills |
            | `.github/prompts/` | Prompt templates |
            | `.devcontainer/` | Dev container configuration |
            | `mcp/` | Model Context Protocol servers |
            | `scripts/` | Utility scripts |

            ### Synced Configuration Files
            | File | Purpose |
            |------|---------|
            | `lefthook.yml` | Git hooks configuration |
            | `.gitignore` | Git ignore patterns |
            | `.gitattributes` | Git attributes (line endings, etc.) |
            | `.editorconfig` | Editor configuration |
            | `.markdownlint.json` | Markdown linting rules |
            | `.markdownlint-cli2.jsonc` | Markdown linting config |
            | `.markdownlintignore` | Markdown linting ignore patterns |
            | `.markdown-link-check.json` | Link checking configuration |
            | `commitlint.config.js` | Commit message linting rules |
            | `package.json.upstream` | npm dependencies (for manual review) |

            ### Sync Behavior
            - ‚úÖ **Source always wins** - Existing files are overwritten
            - ‚úÖ **--delete flag** - Removed files in upstream are removed here (folders only)
            - ‚úÖ **Full content sync** - All files in target folders/configs are updated
            - ‚ö†Ô∏è **package.json** - Creates `.upstream` version for manual review to preserve workshop identity

            ### Review Checklist
            - [ ] Review changed agent definitions
            - [ ] Verify instruction files are appropriate
            - [ ] Test MCP servers if updated
            - [ ] Confirm skills work correctly

            ---
            *Auto-generated by the upstream sync workflow*
          branch: "chore/sync-upstream-${{ steps.version.outputs.version }}"
          labels: |
            sync
            automated
          draft: false
